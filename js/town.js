$(function(){function e(e){$("title").text(e.name+"的天氣概況 - Weather Maps"),r=$("<div />").attr("id","map"),p=$("<div />").attr("id","view"),c=$("<div />").addClass("loading_data").text("資料讀取中.."),h=$("<botton />").addClass("view_button"),o=$("<div />").addClass("map").append(Array.apply(null,Array(4)).map(function(){return $("<i />")})).append(r).append(p).append(c).append(h),u=$("<div />").addClass("l"),m=$("<div />").addClass("describe"),w=$("<div />").addClass("humidity"),v=$("<div />").addClass("rainfall"),g=$("<div />").addClass("created_at"),C=$("<h2 />"),x=$("<img />"),_=$("<div />").addClass("describe"),b=$("<div />").addClass("created_at"),f=$("<div />").addClass("special").append(C).append($("<div />").addClass("describes").append(x).append(_)).append(b),y=$("<div />").addClass("tempers"),T=$("<div />").addClass("times"),L=$("<div />").addClass("details").append(y).append(T),s=$("<div />").addClass("info").append($("<div />").addClass("weather").append(u).append($("<div />").addClass("r").append(m).append($("<div />").addClass("sub_describe").append(w).append(v)).append(g))).append(f).append(L),l=$("<div />").addClass("infos").append(o).append(s),d.prepend(l),z=$("<div />").addClass("towns"),S=$("<div />").addClass("loading"),k=$("<div />").addClass("more_towns").append($("<h2 />").text("更多地方天氣！")).append(z).append(S),d.append(k)}function a(a){var t=null,d=null;e(a),a.view&&(t=new google.maps.StreetViewPanorama(p.get(0),{linksControl:!0,addressControl:!1,position:new google.maps.LatLng(a.view.lat,a.view.lng),pov:{heading:a.view.heading,pitch:a.view.pitch,zoom:a.view.zoom}})),d=new google.maps.Map(r.get(0),{zoom:$(window).height()<n?11:12,zoomControl:!0,scrollwheel:!0,scaleControl:!0,streetView:t?t:null,mapTypeControl:!1,navigationControl:!0,streetViewControl:!1,disableDoubleClickZoom:!0,center:new google.maps.LatLng(a.lat,a.lng)});var l=initWeatherFeature(a,d,!1);if(d.setCenter(l.position),l.setMap(d),google.maps.event.addListener(d,"zoom_changed",getWeathers.bind(this,d,a.id,c,!1)),google.maps.event.addListener(d,"idle",getWeathers.bind(this,d,a.id,c,!1)),u.append($(a.content)),m.text(a.weather.describe),w.text("溫濕度："+a.weather.humidity+"%"),v.text("降雨量："+a.weather.rainfall+"mm"),g.text(a.weather.created_at).data("time",a.weather.created_at).timeago(),0===a.weather.special.length?(f.remove(),L.addClass("heighter")):(C.text(a.weather.special.status+"特報"),x.attr("src",a.weather.special.icon),_.text(a.weather.special.describe),b.text(a.weather.special.at).data("time",a.weather.special.at).timeago()),a.weathers){L.addClass("c"+a.weathers.length),T.append(a.weathers.map(function(e){return $("<div />").addClass("time").text(e.hour)}));var j=a.weathers.max("temperature"),A=(3*a.weathers.min("temperature")-j)/2;y.append(a.weathers.column("temperature").map(function(e){return $("<div />").addClass("temper").data("height","calc((100% - 10px) * "+(e-A)/(j-A)+")").append($("<div />").text(e+"°c")).append($("<div />"))}))}else L.remove();$(window).scroll(function(){y.data("has_loaded")||$(this).scrollTop()+$(this).height()<y.offset().top||(y.data("has_loaded",!0),clearTimeout(y.timer),y.timer=setTimeout(function(){y.find(".temper").each(function(){$(this).css("height",$(this).data("height"))})},1e3))}).scroll(function(){k.data("has_loaded")||$(this).scrollTop()+$(this).height()<S.offset().top-10||(k.data("has_loaded",!0),$.ajax({url:window.api.getMoreTownsUrl,data:{id:a.id},async:!0,cache:!1,dataType:"json",type:"POST",beforeSend:function(){}}).done(function(e){if(!e.status)return k.remove();var t=(new Date).getTime(),n=getStorage("weather_maps_viewed");n||(n=[]),n=n.filter(function(e){return t-e.t<864e5});var d=[{id:a.id,t:t}];n=n.diff(d,"id");var i=d.diff(n,"id");n=n.concat(i),setStorage("weather_maps_viewed",n),n=n.map(function(e){return parseInt(e.id,10)}),z.append(e.towns.map(function(e){return $("<a />").addClass(-1!=$.inArray(e.id,n)?"viewed":null).attr("href",window.url+"town.html#"+encodeURIComponent(e.id)).addClass("town").append($("<img />").attr("src",e.src)).append($("<div />").addClass("name").text(e.name)).click(function(){window.location.hash=encodeURIComponent(e.id)}).append($("<div />").addClass("tick").addClass("icon-uniE63B"))})).find("a").imgLiquid({verticalAlign:"center"}),S.remove()}).fail(function(e){ajaxError(e)}).complete(function(){}))}).scroll().resize(function(){$(this).width()>n?o.css({height:s.height()}):o.removeAttr("style")}).resize(),t?(h.click(function(){i=!0,o.hasClass("panorama")?o.removeClass("panorama"):o.addClass("panorama")}),i||setTimeout(function(){i||h.click()},2e3)):h.remove(),window.closeLoading()}var t=window.location.hash.trim().slice(1),n=800;if(window.onhashchange=function(){location.reload()},!t)return window.location.assign("index.html"),void 0;var d=$("#container"),i=!1,l=null,s=null,o=null,r=null,p=null,c=null,h=null,u=null,m=null,w=null,v=null,g=null,f=null,C=null,x=null,_=null,b=null,y=null,T=null,L=null,k=null,z=null,S=null;$.ajax({url:window.api.getTownUrl,data:{key:t},async:!0,cache:!1,dataType:"json",type:"POST",beforeSend:function(){}}).done(function(e){e.status?a(e.town):window.location.assign("index.html")}).fail(function(e){ajaxError(e)}).complete(function(){})});