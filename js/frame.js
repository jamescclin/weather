function initLocalInfo(t,e,a,n){$.ajax({url:window.api.getWeatherContentByPostalCodeUrl,data:{postal_code:t},async:!0,cache:!1,dataType:"json",type:"POST",beforeSend:function(){}}).done(function(o){o.status?(e&&setStorage("weather_maps_last_postal_code",{code:t,result:o,category:o.town.category,name:o.town.name,t:(new Date).getTime()}),a&&a(o)):n&&n()}).fail(function(t){ajaxError(t)}).complete(function(){})}function getLocalInfo(t,e){var a=(new Date).getTime(),n=getStorage("weather_maps_last_postal_code");n&&a-n.t<36e5?t&&t(n.result):navigator.geolocation.getCurrentPosition(function(a){(new google.maps.Geocoder).geocode({latLng:new google.maps.LatLng(a.coords.latitude,a.coords.longitude)},function(a,n){var o=[];n==google.maps.GeocoderStatus.OK&&a.length&&(a=a[0])&&(o=a.address_components.map(function(t){return t.types.length&&-1!==$.inArray("postal_code",t.types)?t.long_name:null}).filter(function(t){return t})),o=o.length?o[0]:"",""===o?initLocalInfo(100,!1,t,e):initLocalInfo(o,!0,t,e)})},function(){initLocalInfo(100,!1,t,e)})}function initWeatherFeature(t,e,a){var n=new MarkerWithLabel({id:t.id,position:new google.maps.LatLng(t.lat,t.lng),draggable:!1,raiseOnDrag:!1,clickable:a,labelContent:t.content,labelAnchor:new google.maps.Point(65,100),labelClass:"marker_label",icon:{path:"M 0 0"},initCallback:function(t){$(t).find(".icon").imgLiquid({verticalAlign:"center"})}});return a&&google.maps.event.addListener(n,"click",function(){mapGo(e,new google.maps.LatLng(t.lat,t.lng),function(t){setStorage.apply(this,["weather_maps_last",{lat:t.center.lat(),lng:t.center.lng(),zoom:t.zoom}]),t.setZoom(t.zoom+1)}),clearTimeout(e.toTownTimmer),e.toTownTimmer=setTimeout(function(){window.location.assign("town.html#"+encodeURIComponent(t.id))},500)}),n}function getWeathers(t,e,a,n){clearTimeout(t.getWeathersTimer),t.getWeathersTimer=setTimeout(function(){if(!t.isGetWeathers){t.markers||(t.markers=[]),a&&a.addClass("show"),t.isGetWeathers=!0;var n=t.getBounds().getNorthEast(),o=t.getBounds().getSouthWest();$.ajax({url:window.api.getWeathersUrl,data:{NorthEast:{latitude:n.lat(),longitude:n.lng()},SouthWest:{latitude:o.lat(),longitude:o.lng()},townId:e?e:0,zoom:t.zoom},async:!0,cache:!1,dataType:"json",type:"POST",beforeSend:function(){}}).done(function(e){if(e.status){var n=e.weathers.map(function(e){return{id:e.id,markerWithLabel:initWeatherFeature(e,t,!0)}}),o=t.markers.diff(n,"id"),i=n.diff(t.markers,"id"),r=o.map(function(t){return t.markerWithLabel.setMap(null),t.id}),l=i.map(function(e){return e.markerWithLabel.setMap(t),e.id});t.markers=t.markers.filter(function(t){return-1==$.inArray(t.id,r)}).concat(n.filter(function(t){return-1!=$.inArray(t.id,l)})),a&&a.removeClass("show"),t.isGetWeathers=!1}}).fail(function(t){ajaxError(t)}).complete(function(){})}},100),n||setStorage.apply(this,["weather_maps_last",{lat:t.center.lat(),lng:t.center.lng(),zoom:t.zoom}])}function getStorage(t){return"undefined"!=typeof Storage&&(last=localStorage.getItem(t))&&(last=JSON.parse(last))?last:void 0}function setStorage(t,e){"undefined"!=typeof Storage&&localStorage.setItem(t,JSON.stringify(e))}function getLastPosition(t){return"undefined"!=typeof Storage&&(last=getStorage(t))&&!isNaN(last.lat)&&!isNaN(last.lng)&&!isNaN(last.zoom)&&last.lat<86&&last.lat>-86?last:void 0}function getUnit(t,e){var a=t.lat()-e.lat(),n=t.lng()-e.lng(),o=(Math.abs(a)+Math.abs(n))/2,i=10>o?1>o?.1>o?.01>o?.001>o?1e-4>o?3:6:9:12:15:24:21,r=a/i,l=n/i;return Math.abs(r)>0||Math.abs(l)>0?{unit:i,lat:r,lng:l}:null}function mapMove(t,e,a,n,o,i){o>n?(t.setCenter(new google.maps.LatLng(t.getCenter().lat()+e,t.getCenter().lng()+a)),clearTimeout(window.mapMoveTimer),window.mapMoveTimer=setTimeout(function(){mapMove(t,e,a,n+1,o,i)},25)):i&&i(t)}function mapGo(t,e,a){var n=t.center,o=getUnit(e,n);return o?(mapMove(t,o.lat,o.lng,0,o.unit,a),void 0):!1}var ENVIRONMENT="production";"dev"==ENVIRONMENT?(window.url="http://dev.comdan66.github.io/weather/",window.api={getTownUrl:"http://dev.weather.ioa.tw/api/github/get_town/",getTownsUrl:"http://dev.weather.ioa.tw/api/github/get_towns/",getIndexData:"http://dev.weather.ioa.tw/api/github/get_index_data/",getWeathersUrl:"http://dev.weather.ioa.tw/api/github/get_weathers/",getMoreTownsUrl:"http://dev.weather.ioa.tw/api/github/get_more_town/",getSatellitesUrl:"http://dev.weather.ioa.tw/api/github/get_satellites/",getWeatherByNameUrl:"http://dev.weather.ioa.tw/api/github/get_weather_by_name/",getWeatherContentByPostalCodeUrl:"http://dev.weather.ioa.tw/api/github/get_weather_content_by_postal_code/"}):(window.url="http://comdan66.github.io/weather/",window.api={getTownUrl:"http://weather.ioa.tw/api/github/get_town/",getTownsUrl:"http://weather.ioa.tw/api/github/get_towns/",getIndexData:"http://weather.ioa.tw/api/github/get_index_data/",getWeathersUrl:"http://weather.ioa.tw/api/github/get_weathers/",getMoreTownsUrl:"http://weather.ioa.tw/api/github/get_more_town/",getSatellitesUrl:"http://weather.ioa.tw/api/github/get_satellites/",getWeatherByNameUrl:"http://weather.ioa.tw/api/github/get_weather_by_name/",getWeatherContentByPostalCodeUrl:"http://weather.ioa.tw/api/github/get_weather_content_by_postal_code/"},function(t,e,a,n,o,i,r){t.GoogleAnalyticsObject=o,t[o]=t[o]||function(){(t[o].q=t[o].q||[]).push(arguments)},t[o].l=1*new Date,i=e.createElement(a),r=e.getElementsByTagName(a)[0],i.async=1,i.src=n,r.parentNode.insertBefore(i,r)}(window,document,"script","//www.google-analytics.com/analytics.js","ga"),ga("create","UA-46121102-7","auto"),ga("send","pageview")),Array.prototype.column=function(k){return this.map(function(t){return k?eval("t."+k):t})},Array.prototype.diff=function(a,k){return this.filter(function(i){return a.column(k).indexOf(eval("i."+k))<0})},Array.prototype.max=function(t){return Math.max.apply(null,this.column(t))},Array.prototype.min=function(t){return Math.min.apply(null,this.column(t))},window.ajaxError=function(t){console.error(t.responseText)},$(function(){var t="Weather Maps",e={left:[{name:"首頁",file:"index.html",target:"_self"},{name:"搜尋",file:"search.html",target:"_self"},{name:"地圖",file:"maps.html",target:"_self"},{name:"衛星雲圖",file:"satellites.html",target:"_self"}],right:[{name:"關於",file:"about.html",target:"_self"},{name:"更多",file:"http://comdan66.github.io/index.html",target:"_blank"}]},a=["Weather Maps © 2015","如有相關問題歡迎與<a href='https://www.facebook.com/comdan66' target='_blank'>作者</a>討論。"],n=e.left.concat(e.right);if(n.length){var o=document.URL.replace(/^.*[\\\/]/,""),i=n.filter(function(t){return t.file==o});i.length&&(i=i[0])&&$("title").text(i.name+" - Weather Maps");{var r=$("body"),l=r.css("overflow"),s=null,d=($("<div />").attr("id","header").append($("<div />").addClass("header_container").append($("<div />").addClass("l").append($("<a />").addClass("home").addClass("icon-home").attr("href",window.url+"index.html").attr("target","_self")).append(e.left.map(function(t){return $("<a />").addClass(t.file==o?"active":null).attr("href",window.url+t.file).attr("target",t.target).text(t.name)}))).append($("<div />").addClass("c").text(t).click(function(){$("html, body").stop().animate({scrollTop:-50},500)})).append($("<div />").addClass("r").append(s=$("<a />").addClass("option").addClass("icon-th-menu").click(function(){d.hasClass("close")?(d.removeClass("close"),$("body").css("overflow","hidden"),$(this).addClass("close")):(d.addClass("close"),$("body").css("overflow",l),$(this).removeClass("close"))})).append(e.right.map(function(t){var e=/(http(s?))\:\/\//gi;return $("<a />").addClass(t.file==o?"active":null).attr("href",e.test(t.file)?t.file:window.url+t.file).attr("target",t.target).text(t.name)})))).prependTo(r),$("<div />").attr("id","header_slide_cover").click(function(){d.hasClass("close")||(d.addClass("close"),$("body").css("overflow",l),s.removeClass("close"))}).prependTo(r),$("<div />").attr("id","header_right_slide").addClass("close").append($("<div />").addClass("right_slide_container").append(n.map(function(t){return $("<a />").addClass(t.file==o?"active":null).addClass("sub").attr("href",window.url+t.file).attr("target",t.target).text(t.name)}))).prependTo(r));$("<div />").attr("id","footer").append($("<div />").addClass("l")).append($("<div />").addClass("c").append(a.map(function(t){return $("<div />").html(t)}))).append($("<div />").addClass("r")).appendTo(r)}window.mainLoading=$("<div />").attr("id","main_loading").append($("<div />")).appendTo(r),window.closeLoading=function(){this.mainLoading.fadeOut(function(){$(this).hide(function(){$(this).remove()})})}}});